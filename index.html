<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gateball Map¬Æ | AGARI</title>

  <meta name="description"
  content="A growing interactive map of Gateball courts and communities. Managed by AGARI to support the growth of Gateball nationwide." />
  
  <link rel="canonical" href="https://map.agari.id/" />

<!-- favicon -->
<link rel="icon" href="public/favicon.ico" />

<!-- supabase/backend -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<!-- MAPBOX -->
<link
href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
rel="stylesheet"
/>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<style>
body { margin: 0; font-family: "Noto Sans JP", system-ui, sans-serif; }
#map { position: fixed; inset: 0; }

/* ===== PREVENT PULL TO REFRESH ===== */
html, body {
overscroll-behavior-y: none;
}

/* ===== LOCK SCROLL WHEN SHEET OPEN ===== */
body.sheet-open {
overflow: hidden;
touch-action: none;
}
/* ===== DRAG PREP ===== */
.sheet {
will-change: transform;
touch-action: pan-y;
}
.sheet-handle {
touch-action: pan-y;
}

.sheet.dragging {
transition: none; /* finger-follow */
}
/* ===== HARD BLOCK iOS CALLOUT ON MAPBOX CANVAS ===== */
.mapboxgl-canvas {
-webkit-user-select: none !important;
user-select: none !important;
-webkit-touch-callout: none !important;
}



/* ===== AGARI ===== */
.agari-marker {
width: 50px;
height: 50px;
background-image: url("public/markers/agari-pin-10kb.png");
background-size: contain;
background-repeat: no-repeat;
cursor: pointer;
filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25));
}

/* ===== BOTTOM SHEET ===== */
.sheet {
position: fixed;
left: 0; right: 0; bottom: 0;
background: #fff;
border-radius: 20px 20px 0 0;
padding: 12px 20px 20px;
transform: translateY(100%);
transition: transform .35s ease;
box-shadow: 0 -10px 30px rgba(0,0,0,.15);
z-index: 20;
}
/* üëâ BIAR BUTTON & LINK GAK KETARIK DRAG */
.sheet a,
.sheet button {
touch-action: manipulation;
}
.sheet-header {
  position: relative;
  padding-top: 2px;
}
.sheet-header h2 {
font-size: 20px;
font-weight: 600;
margin: 0;
line-height: 1.25;
max-width: 100%;
word-break: break-word;
}
.sheet.show { transform: translateY(0);
}
.sheet-handle {
width: 40px; height: 4px;
background: #ccc;
margin: 0 auto 12px;
border-radius: 2px;
}
/* ===== BADGES ===== */
.sheet-badges {
flex-direction: column;
display: flex;
gap: 6px;
align-items: flex-end;
}
.status-badge, .verified-badge, .unverified-badge {
display: inline-block;
font-size: 11px;
padding: 4px 10px;
border-radius: 999px;
font-weight: 500;
}
.status-active { background:#e6f6ee;color:#0f7a4a; }
.status-inactive { background:#fdecec;color:#a02a2a; }
.verified-badge { background:#e8f8ef;color:#1e7f4f; }
.unverified-badge { background:#f2f2f2;color:#666; }

/* ===== ADDRESS ===== */
.sheet-address {
font-size: 13px;
color: #666;
line-height: 1.4;
margin: 8px 0 16px;
max-width: 100%;
word-break: break-word;
}

/* ===== META GRID ===== */
.sheet-meta {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 14px 16px;
margin-bottom: 18px;
}

.sheet-meta span {
font-size: 12px;
color: #999;
}

.sheet-meta strong {
display: block;
margin-top: 2px;
font-size: 14px;
font-weight: 500;
color: #111;
}

/* ===== VERIFY LINK ===== */
.sheet-verify-wrap {
display: flex;
justify-content: center;
margin: 8px 0 14px;
}

.sheet-verify {
display: inline-block;
font-size: 13px;
color: #555;
text-decoration: underline;
}

body.sheet-open #agari-search {
  opacity: 0.4;
}

body.sheet-open #agari-search-plus {
  background: rgba(0,0,0,0.5);
}
#agari-search.is-dimmed {
  opacity: 0.4;
}

/* ===== CTA ===== */
.sheet-cta-wrap {
display: flex;
justify-content: center;
}

.sheet-button {
text-align: center;
padding: 14px;
background: #111;
color: #fff;
text-decoration: none;
border-radius: 12px;
font-size: 15px;
}

/* CTA ROW */
.sheet-cta-row {
  display: flex;
  gap: 8px;
  width: 100%;
}

/* GET DIRECTIONS ‚Äî SATU-SATUNYA YANG BOLEH MELEBAR */
.sheet-button.primary {
  flex: 1;
  min-width: 0;
  background: #111;
  color: #fff;
}

/* BOOK ‚Äî SEMI FLEX */
.sheet-button.secondary {
  flex: 0 1 22%;
  min-width: 96px;
  max-width: 160px;
  padding: 14px 16px;
  background: #eaeaea;
  color: #111;
  font-size: 14px;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* THUMBS UP ‚Äî FIXED ICON */
.sheet-button.icon {
  flex: 0 0 48px;
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #eaeaea;
  font-size: 18px;
  padding: 0;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mapboxgl-ctrl-attrib a {
display: none !important;
}
/* ===== OVERLAY ROOT ===== */
#overlay-root {
position: fixed;
inset: 0;
z-index: 15;        /* di atas map (0), di bawah sheet (20) */
pointer-events: none;
}

/* ===== POWERED BY AGARI ===== */
#agari-powered {
position: absolute;
right: 16px;
bottom: 12px;

font-size: 14px;
letter-spacing: 0.04em;
color: rgba(255,255,255,0.8);
white-space: nowrap;
}
/* ===== DISCLAIMER OVERLAY ===== */

#disclaimer-overlay {
position: fixed;
inset: 0;
z-index: 999;
background: rgba(0,0,0,0.45);
backdrop-filter: blur(6px);
display: flex;
align-items: center;
justify-content: center;
}

.disclaimer-card {
background: #fff;
max-width: 420px;
width: calc(100% - 32px);
padding: 24px;
border-radius: 20px;
text-align: center;
box-shadow: 0 20px 40px rgba(0,0,0,.2);
}

.disclaimer-card h2 {
margin: 0 0 12px;
font-size: 20px;
font-weight: 600;
}

.disclaimer-card p {
font-size: 14px;
color: #444;
line-height: 1.5;
margin-bottom: 14px;
}

.disclaimer-card ul {
text-align: left;
padding-left: 18px;
margin: 0 0 18px;
font-size: 13px;
color: #555;
}

.disclaimer-card li {
margin-bottom: 6px;
}

.disclaimer-card button {
width: 100%;
padding: 14px;
border-radius: 12px;
border: none;
background: #111;
color: #fff;
font-size: 15px;
font-weight: 500;
}

.disclaimer-card small {
display: block;
margin-top: 12px;
font-size: 12px;
color: #777;
}

/* ===== SEARCH BAR ===== */
.agari-search-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}

#agari-search-input {
  flex: 1;
  padding: 14px 16px;
  font-size: 16px;
  border-radius: 16px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.92);
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}


#agari-search-plus {
  flex-shrink: 0;
  width: 42px;
  height: 42px;
  border-radius: 999px;
  border: none;
  background: rgba(0,0,0,0.85);
  color: #fff;
  font-size: 22px;
  line-height: 1;
  cursor: pointer;
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
}

#agari-search-plus:active {
  transform: scale(0.94);
}

#agari-search {
  position: fixed;
  top: 16px;
  left: 12px;
  width: auto;
  z-index: 60;
  font-family: inherit;
  transition: opacity 0.25s ease;
}

#agari-search-results {
  list-style: none;
  margin: 8px 0 0;
  padding: 0;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
  max-height: 320px;
  overflow-y: auto;
}

#agari-search-results li {
  padding: 10px 14px;
  font-size: 13px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

#agari-search-results li:last-child {
  border-bottom: none;
}

#agari-search-results li:hover {
  background: #f2f1ed;
}

/* Mobile tweak */
@media (max-width: 640px) {
  #agari-search {
    width: calc(100vw - 24px);
  }

  #agari-search-input {
    font-size: 16px; /* prevent iOS zoom */
  }
}
/* ===== DESKTOP TOP BAR WIDTH ===== */
@media (min-width: 768px) {
  #agari-search {
    left: 24px;
    right: auto;

    width: min(25vw, 520px);
  }
}

.sheet-title {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
  width: 100%;
  line-height: 1.25;
  word-break: break-word;
}

.sheet-submeta {
  margin-top: 6px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  font-size: 12px;
  color: #555;
}

.submeta {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* STYLE PER ITEM */
.submeta {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  font-weight: 500;
}

/* VERIFIED */
.submeta.verified {
  background: #e6f6ee;
  color: #0f7a4a;
}

/* UNVERIFIED */
.submeta.unverified {
  background: #fff3cd;
  color: #8a6d00;
}

/* STATUS */
.submeta.status.active {
  background: #e6f6ee;
  color: #0f7a4a;
}

.submeta.status.inactive {
  background: #fdecec;
  color: #a02a2a;
}

.submeta.like {
  background: #f2f2f2;
  color: #111;
}
/* LIKE BADGE ANIMATION */
.submeta.like {
  opacity: 0;
  transform: scale(0.9);
  transition:
    opacity 0.18s ease,
    transform 0.18s ease;
}

/* saat visible */
.submeta.like.is-visible {
  opacity: 1;
  transform: scale(1);
}

.sheet-title-row {
  display: block;
}


.sheet-title-row h2 {
  flex: 1;
  min-width: 0;
}

.like-badge {
  display: inline-flex;
  align-items: center;
  font-size: 12px;
  line-height: 1;          /* üîë ini penting */
  padding: 4px 8px;
  border-radius: 999px;
  background: #f2f2f2;
  color: #111;
  white-space: nowrap;
  flex-shrink: 0;
}
.sheet-button.icon {
  transition:
    background-color 0.25s ease,
    transform 0.18s ease,
    box-shadow 0.25s ease;
}
.sheet-button.icon.liked {
  background: #22c55e;
  color: #fff;
  transform: scale(1.05);
}

/* ===== SEARCH SKELETON ===== */
.search-skeleton {
  height: 14px;
  width: 100%;
  border-radius: 6px;
  background: linear-gradient(
    90deg,
    #eee 25%,
    #f5f5f5 37%,
    #eee 63%
  );
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
}

.search-skeleton.small {
  width: 60%;
}


  </style>

  <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Gateball Map of Indonesia",
  "description": "Interactive map of Gateball courts and communities across Indonesia, powered by AGARI.",
  "publisher": {
    "@type": "Organization",
    "name": "AGARI",
    "url": "https://www.agari.id"
  },
  "url": "https://map.agari.id/"
}
</script>

</head>

<body>

<!-- ===== DISCLAIMER OVERLAY ===== -->
<div id="disclaimer-overlay">
<div class="disclaimer-card">
<h2>AGARI Gateball Map</h2>

<p>
Community-driven map of everything Gateball-related. 
Some court data may be incomplete or not yet verified.
</p>

<ul>
<li>‚úî AGARI Verified courts are reviewed</li>
<li>üìç Locations may change over time</li>
<li>‚ö† Always confirm availability before visiting</li>
</ul>

<button id="disclaimer-accept">
Enter Map
</button>

<small>
Want to help improve this map?
</small>
</div>
</div>

<div id="overlay-root">
<div id="agari-powered">
Powered by AGARI ¬© 2026
</div>
</div>

<!-- ===== SEARCH BAR ===== -->
<div id="agari-search">
  <div class="agari-search-bar">
    <input
      id="agari-search-input"
      type="search"
      placeholder="Search Gateball Map¬Æ"
      autocomplete="off"
    />
    <button id="agari-search-plus" aria-label="Contribute">
      +
    </button>
  </div>
  <ul id="agari-search-results"></ul>
</div>


<div id="map"></div>

  <!-- ===== SEO CONTENT (VISIBLE TO CRAWLERS) ===== -->
<section id="seo-content" style="
  position: absolute;
  left: -9999px;
  top: 0;
  width: 1px;
  height: 1px;
  overflow: hidden;
  opacity: 0.01;
  pointer-events: none;
">

  <h1>Gateball Map of Indonesia</h1>

  <p>
    This interactive map shows Gateball courts, clubs, and communities across Indonesia.
    It is maintained by AGARI to document and support the growth of Gateball nationwide.
  </p>

  <h2>Gateball Communities Across Provinces</h2>
  <p>
    Gateball was introduced to Indonesia in 2013 and has since expanded to multiple provinces.
    This map helps players, organizers, and newcomers discover Gateball locations and verified courts.
  </p>

  <h2>About AGARI Gateball Map</h2>
  <p>
    AGARI Gateball Map is a community-driven project.
    Some locations are verified by AGARI, while others rely on public submissions.
  </p>
</section>


<div id="agari-sheet" class="sheet">

  <div class="sheet-handle"></div>

  <div class="sheet-header">

  <div class="sheet-header">
  <h2 id="sheet-name" class="sheet-title"></h2>
</div>

<div class="sheet-submeta">
  <span id="sheet-verified" class="submeta verified" style="display:none;">
    ‚úî AGARI Verified
  </span>

  <span id="sheet-unverified" class="submeta unverified" style="display:none;">
    ‚ö† Unverified
  </span>

  <span id="sheet-status" class="submeta status" style="display:none;">
    Active
  </span>

  <span id="sheet-like-count" class="submeta like">
    üëç 0
  </span>
</div>



  <p id="sheet-address" class="sheet-address"></p>

  <div class="sheet-meta">
    <div>
      <span>Community</span>
      <strong id="sheet-community"></strong>
    </div>

    <div>
      <span>Courts</span>
      <strong id="sheet-courts"></strong>
    </div>

    <div>
      <span>Surface</span>
      <strong id="sheet-surface"></strong>
    </div>

    <div>
      <span>Location</span>
      <strong id="sheet-location"></strong>
    </div>
  </div>

  <div class="sheet-verify-wrap">
    <a id="sheet-verify-cta"
       class="sheet-verify"
       target="_blank"
       href="https://www.agari.id/submit-your-location">
      Help us verify this court
    </a>
  </div>

  <div class="sheet-cta-row">
    <a id="sheet-directions"
       class="sheet-button primary"
       target="_blank">
      Get Directions
    </a>

    <a id="sheet-book"
       class="sheet-button secondary"
       target="_blank">
      Book
    </a>

    <button id="sheet-like"
            class="sheet-button icon"
            aria-label="Like this court">
      üëç
    </button>
  </div>

</div>

<script>

// ===== SUPABASE CLIENT =====
const SUPABASE_URL = "https://ocavvmkaeypwzcegvtuo.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_rjs1fxeOnmYj4DwMIP1EAA_n41DDzcq";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_PUBLISHABLE_KEY
);

function getDeviceId() {
  let id = localStorage.getItem("agari_device_id");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("agari_device_id", id);
  }
  return id;
}

async function hasUserLiked(fieldId) {
  if (!canUseBackendFeatures()) return false;

  const deviceId = getDeviceId();

  const { data, error } = await supabaseClient
    .from("votes")
    .select("id")
    .eq("field_id", fieldId)
    .eq("device_id", deviceId)
    .limit(1);

  if (error) {
    console.warn("[hasUserLiked error]", error);
    return false;
  }

  return data.length > 0;
}

async function toggleLike(fieldId) {
  const deviceId = getDeviceId();

  const liked = await hasUserLiked(fieldId);

  if (liked) {
    // UNLIKE
    await supabaseClient
      .from("votes")
      .delete()
      .eq("field_id", fieldId)
      .eq("device_id", deviceId);
  } else {
    // LIKE
    await supabaseClient
      .from("votes")
      .insert({
        field_id: fieldId,
        device_id: deviceId
      });
  }

  return !liked; // state baru
}

async function fetchLikeCount(fieldId) {
  if (!canUseBackendFeatures()) return null;

  const { data, error } = await supabaseClient
  .rpc("get_like_count", { fid: fieldId });


  if (error) {
    console.warn("[Like count error]", error);
    return null;
  }

  return data;
}

async function safeSupabaseCall(fn) {
  try {
    return await fn();
  } catch (err) {
    console.warn("[Supabase unavailable]", err);
    return null;
  }
}

let isBackendAvailable = true;
let likeFetchToken = 0;
let activeFieldId = null;


async function checkBackendAvailability() {
  const result = await safeSupabaseCall(() =>
    supabaseClient.auth.getSession()
  );

  isBackendAvailable = result !== null;

  console.log("Backend available:", isBackendAvailable);
}

// ===== DISCLAIMER LOGIC =====
const overlay = document.getElementById("disclaimer-overlay");
const acceptBtn = document.getElementById("disclaimer-accept");

// cek apakah user udah pernah accept
const hasAccepted = localStorage.getItem("agari-map-disclaimer");

if (hasAccepted === "true") {
overlay.style.display = "none";
} else {
// lock body + map sementara
document.body.style.overflow = "hidden";
}

acceptBtn.addEventListener("click", () => {
localStorage.setItem("agari-map-disclaimer", "true");
overlay.style.display = "none";
document.body.style.overflow = "";
});

mapboxgl.accessToken = "pk.eyJ1IjoiYWdhcmlhcHBhcmVsIiwiYSI6ImNta2VmM2g4eDA2MnQzZ3F3bzl1a3dldjcifQ.O0kAhVcu1M_ujwu4NxmOXA";

const map = new mapboxgl.Map({
container: "map",
style: "mapbox://styles/agariapparel/cmksk3qy2004001seatdvd9sz",
center: [116, -2.7],
zoom: 3
});

function showSearchSkeleton() {
  searchResults.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const li = document.createElement("li");

    li.innerHTML = `
      <div class="search-skeleton"></div>
      <div class="search-skeleton small" style="margin-top:6px;"></div>
    `;

    searchResults.appendChild(li);
  }
}

// ===== SEARCH LOGIC =====
const searchInput = document.getElementById("agari-search-input");
const searchResults = document.getElementById("agari-search-results");
const CONTRIBUTE_URL = "https://agari.id/submit-your-location";
const plusBtn = document.getElementById("agari-search-plus");

plusBtn.addEventListener("click", () => {
  haptic("light");
  window.open(CONTRIBUTE_URL, "_blank");
});


function normalize(str = "") {
  return str.toLowerCase();
}
function closeSearchResults() {
  searchResults.innerHTML = "";
}
let searchDebounceTimer = null;


if (!localStorage.getItem("agari-map-disclaimer")) {
map.boxZoom.disable();
map.doubleClickZoom.disable();
map.dragPan.disable();
map.dragRotate.disable();
map.keyboard.disable();
map.scrollZoom.disable();
map.touchZoomRotate.disable();
}

document.getElementById("disclaimer-accept").addEventListener("click", () => {
map.boxZoom.enable();
map.doubleClickZoom.enable();
map.dragPan.enable();
map.dragRotate.enable();
map.keyboard.enable();
map.scrollZoom.enable();
map.touchZoomRotate.enable();
});

map.on("load", () => {
console.log("Map loaded");

// üî• HIDE MARKER & LABEL BAWAAN MAPBOX
if (map.getLayer("Icon")) {
map.setLayoutProperty("Icon", "visibility", "none");
}

if (map.getLayer("Label")) {
map.setLayoutProperty("Label", "visibility", "visible");
}
});

const canvas = map.getCanvas();

const searchBar = document.getElementById("agari-search");

searchInput.addEventListener("focus", () => {
  // üîí Tutup bottom sheet kalau lagi kebuka
  closeBottomSheet(true);

  // üîÜ Pastikan search bar aktif & jelas
  searchBar.classList.remove("is-dimmed");

  // üó∫Ô∏è Hindari map gerak pas ngetik
  map.scrollZoom.disable();
  map.touchZoomRotate.disable();
});

searchInput.addEventListener("blur", () => {
  if (document.body.classList.contains("sheet-open")) {
    searchBar.classList.add("is-dimmed");
  }
});


// block long press & selection on MAP ONLY
["touchstart", "touchmove", "touchend"].forEach(evt => {
canvas.addEventListener(evt, e => {
if (!e.target.closest("#agari-sheet")) {
e.preventDefault();
}
}, { passive: false });
});

canvas.addEventListener("contextmenu", e => e.preventDefault());


// ===== GEOLOCATION =====
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(
pos => {
map.flyTo({
center: [pos.coords.longitude, pos.coords.latitude],
zoom: 5,
essential: true
});
}
);
}

function openBottomSheet(feature) {
const p = feature.properties;

const sheet      = document.getElementById("agari-sheet");
const nameEl     = document.getElementById("sheet-name");
const verifiedEl = document.getElementById("sheet-verified");
const statusEl   = document.getElementById("sheet-status");

const likeEl = document.getElementById("sheet-like-count");

// üîë RESET HANYA JIKA FIELD BERBEDA
if (activeFieldId !== p.field_id) {
  likeEl.classList.remove("is-visible");
  likeEl.textContent = "üëç 0";
}
// tandai field aktif
activeFieldId = p.field_id;
// üîê TOKEN BUAT CEGAH RACE CONDITION
const currentLikeToken = ++likeFetchToken;
if (currentLikeToken !== likeFetchToken) return;


const unverifiedEl = document.getElementById("sheet-unverified");

const addressEl  = document.getElementById("sheet-address");
const communityEl= document.getElementById("sheet-community");
const courtsEl   = document.getElementById("sheet-courts");
const surfaceEl  = document.getElementById("sheet-surface");
const locationEl = document.getElementById("sheet-location");

const verifyCTA  = document.getElementById("sheet-verify-cta");
const directionsEl = document.getElementById("sheet-directions");
const bookEl     = document.getElementById("sheet-book");
const likeBtn    = document.getElementById("sheet-like");

  if (p.field_id && canUseBackendFeatures()) {
    hasUserLiked(p.field_id).then(liked => {
      likeBtn.classList.toggle("liked", liked);
    });
  }

  likeBtn.onclick = async () => {
  if (!p.field_id) return;

  likeBtn.disabled = true;

  try {
    const likedNow = await toggleLike(p.field_id);
    likeBtn.classList.toggle("liked", likedNow);

    // refresh count
    const count = await fetchLikeCount(p.field_id);

    if (typeof count === "number" && count > 0) {
      likeEl.textContent = `üëç ${count}`;
      likeEl.classList.add("is-visible");
    } else {
      likeEl.classList.remove("is-visible");
    }

  } catch (err) {
    console.error("Like toggle failed", err);
  }

  likeBtn.disabled = false;
};


nameEl.textContent = p.name || "";
addressEl.innerText = p.address || "";
communityEl.innerText = p.community || "-";
courtsEl.innerText = p.courts || "-";
surfaceEl.innerText = p.surface || "-";
locationEl.innerText =
(p.city || "") +
(p.province ? ", " + p.province : "") +
(p.country ? ", " + p.country : "");

directionsEl.href = p.google_maps_url || "#";

// ===== BOOK LOGIC =====
if (p.booking_url) {
  bookEl.href = p.booking_url;
  bookEl.style.display = "inline-flex";
} else {
  bookEl.style.display = "none";
}
// ===== LIKE BUTTON LOGIC =====
if (p.field_id && canUseBackendFeatures()) {
  likeBtn.style.display = "inline-flex";
  likeBtn.dataset.fieldId = p.field_id;
} else {
  likeBtn.style.display = "none";
}

// ===== VERIFIED =====
verifiedEl.style.display = "none";
unverifiedEl.style.display = "none";
statusEl.style.display   = "none";
verifyCTA.style.display = "";

const isVerified =
p.verified === true ||
p.verified === "true" ||
p.verified === "TRUE";

if (isVerified) {
verifiedEl.style.display = "inline-flex";
} else {
unverifiedEl.style.display = "inline-flex";
verifyCTA.style.display = "inline";
}
if (p.status) {
  const status = p.status.toLowerCase();

  // set teks
  statusEl.textContent = p.status;

  // bersihin state lama
  statusEl.classList.remove("active", "inactive");

  // tentuin state baru
  if (status === "active") {
    statusEl.classList.add("active");
  } else {
    statusEl.classList.add("inactive");
  }

  // tampilkan sebagai badge
  statusEl.style.display = "inline-flex";
}
if (p.field_id && canUseBackendFeatures()) {
  fetchLikeCount(p.field_id).then(count => {

    // ‚ùå JIKA BUKAN REQUEST TERAKHIR ‚Üí ABAIKAN
    if (currentLikeToken !== likeFetchToken) return;

    if (typeof count === "number" && count > 0) {
      likeEl.textContent = `üëç ${count}`;
      likeEl.classList.add("is-visible");
    } else {
      likeEl.classList.remove("is-visible");
    }
  });
}


sheet.classList.add("show");
document.body.classList.add("sheet-open");
}

function closeBottomSheet(force = false) {
  const sheet = document.getElementById("agari-sheet");
  if (!sheet) return;

  if (force || sheet.classList.contains("show")) {
    sheet.classList.remove("show");
    document.body.classList.remove("sheet-open");
  }
}


// ===== LOAD GEOJSON =====
fetch("./public/gateball-fields.geojson")
.then(res => res.json())
.then(data => {
console.log("TOTAL FEATURES:", data.features.length);

window.AGARI_FEATURES = data.features;

data.features.forEach((feature) => {
const el = document.createElement("div");
el.className = "agari-marker";

// hover cursor
el.addEventListener("mouseenter", () => {
map.getCanvas().style.cursor = "pointer";
});

el.addEventListener("mouseleave", () => {
map.getCanvas().style.cursor = "";
});

new mapboxgl.Marker({
element: el,
anchor: "bottom"
})
.setLngLat(feature.geometry.coordinates)
.addTo(map);


el.addEventListener("click", (e) => {
e.stopPropagation();

map.flyTo({
center: feature.geometry.coordinates,
zoom: Math.max(map.getZoom(), 12),
speed: 0.8,
offset: [0, -200],
essential: true
});

openBottomSheet(feature);
});
});
});

// üëâ klik area map kosong ‚Üí tutup sheet
["dragstart", "zoomstart", "rotatestart"].forEach(evt => {
map.on(evt, closeBottomSheet);
map.on(evt, closeSearchResults);
});


function isTextSelecting() {
const selection = window.getSelection();
return selection && selection.toString().length > 0;
}
function haptic(type = "light") {
if (!("vibrate" in navigator)) return;

if (type === "light") {
navigator.vibrate(10);      // tick kecil
} else if (type === "medium") {
navigator.vibrate([15, 10, 15]); // tick lebih kerasa
}
}


// ===== DRAG BOTTOM SHEET (VELOCITY + INTENT SAFE) =====
const sheet = document.getElementById("agari-sheet");

let startY = 0;
let currentY = 0;
let startTime = 0;

let dragging = false;
let isDraggingIntent = false;

const DRAG_INTENT_THRESHOLD = 10;   // px
const CLOSE_DISTANCE = 120;         // px
const CLOSE_VELOCITY = 0.6;         // px per ms (‚âà flick)


// touch start
sheet.addEventListener("touchstart", (e) => {
if (e.target.closest("a, button")) return;

startY = e.touches[0].clientY;
currentY = startY;
startTime = Date.now();

dragging = true;
isDraggingIntent = false;
});

// touch move
sheet.addEventListener("touchmove", (e) => {
if (!dragging) return;

// üîí jangan ganggu text selection
if (isTextSelecting()) return;

currentY = e.touches[0].clientY;
const delta = currentY - startY;

if (!isDraggingIntent) {
if (Math.abs(delta) < DRAG_INTENT_THRESHOLD) return;

isDraggingIntent = true;
sheet.classList.add("dragging");
}

e.preventDefault();

if (delta > 0) {
sheet.style.transform = `translateY(${delta}px)`;
}
}, { passive: false });

// touch end
sheet.addEventListener("touchend", () => {
if (!dragging) return;

sheet.classList.remove("dragging");

const distance = currentY - startY;
const duration = Date.now() - startTime;
const velocity = distance / duration; // px/ms

const shouldClose =
(distance > CLOSE_DISTANCE) ||
(velocity > CLOSE_VELOCITY);

if (isDraggingIntent && shouldClose) {
haptic("medium");
sheet.classList.remove("show");
document.body.classList.remove("sheet-open");
}
else if (isDraggingIntent) {
haptic("light"); // üîî snap back feedback
}

sheet.style.transform = "";
dragging = false;
isDraggingIntent = false;
});

searchInput.addEventListener("input", () => {
  clearTimeout(searchDebounceTimer);

  const query = searchInput.value.trim();
  if (!query) {
    searchResults.innerHTML = "";
    return;
  }

  // üëâ TAMPILKAN SKELETON LANGSUNG
  showSearchSkeleton();

  searchDebounceTimer = setTimeout(() => {
    const rawQuery = searchInput.value.trim();
    const safeQuery = escapeHTML(rawQuery);
    const query = normalize(rawQuery);
    searchResults.innerHTML = "";

    if (!query || !window.AGARI_FEATURES) return;

    const matches = window.AGARI_FEATURES
      .filter(f => {
        const p = f.properties || {};
        return [
          p.name,
          p.address,
          p.community,
          p.city,
          p.province,
          p.country
        ].some(v => normalize(v).includes(query));
      })
      .slice(0, 10); // üîí MAX 10 RESULT

          // ===== NO RESULT STATE =====
    if (matches.length === 0) {
      const li = document.createElement("li");

    li.innerHTML = `
      <strong>Can‚Äôt find ‚Äú${safeQuery}‚Äù?</strong><br>
      <span style="font-size:12px;color:#666;">
        Contribute now ‚Üí
      </span>
    `;


      li.style.cursor = "pointer";

      li.addEventListener("click", () => {
        window.open(CONTRIBUTE_URL, "_blank");
      });

      searchResults.appendChild(li);
      return;
    }

    matches.forEach(feature => {
      const li = document.createElement("li");
      const p = feature.properties;

      li.textContent = `${p.name || "Unnamed"} ‚Äî ${p.city || p.province || ""}`;

      li.addEventListener("click", () => {
        map.flyTo({
          center: feature.geometry.coordinates,
          zoom: Math.max(map.getZoom(), 12),
          speed: 0.8,
          offset: [0, -200],
          essential: true
          });

        openBottomSheet(feature);

        searchResults.innerHTML = "";
        searchInput.value = "";
        searchInput.blur();
      });

      searchResults.appendChild(li);
    });
  }, 300); // ‚è±Ô∏è debounce delay (ms)
});

// close result when clicking map
map.on("click", closeSearchResults);

searchInput.addEventListener("focus", () => {
  map.scrollZoom.disable();
  map.touchZoomRotate.disable();
});

searchInput.addEventListener("blur", () => {
  map.scrollZoom.enable();
  map.touchZoomRotate.enable();
});

function escapeHTML(str = "") {
  return str.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));
}

function canUseBackendFeatures() {
  return isBackendAvailable === true;
}

setTimeout(() => {
  checkBackendAvailability();
}, 1500);

</script>

</body>
</html>